<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.mohobby.mapper.moim.MoimMapper">

<!-- 소모임 등록 -->
<insert id="moimInsert" parameterType="com.yedam.mohobby.service.moim.MoimVO">
<selectKey keyProperty="moimId" resultType="Integer" order="BEFORE">
   SELECT NVL(MAX(moim_id), 0)+1 FROM moim
</selectKey>
	INSERT INTO moim (
	            moim_id,
	            moim_img,
	            moim_name,
	            moim_info,
	            moim_catg,
	            moim_region,
	            max_people
	            )
	         VALUES
	            (
	            #{moimId},
	            #{moimImg},
	            #{moimName},
	            #{moimInfo},
	            #{moimCatg},
	            #{moimRegion},
	            #{maxPeople}
	            )
</insert>
<!-- 소모임 모집 전체 조회(6개씩) -->
<select id="moimrecruitMember" resultType="com.yedam.mohobby.service.moim.MoimVO">
   select * from moim <![CDATA[where rownum <= 6]]>
</select>

<!-- 인기소모임 조회 -->
<select id="moimPopularSelect" resultType="com.yedam.mohobby.service.moim.MoimVO">
   SELECT * FROM moim <![CDATA[where rownum <= 6]]> ORDER BY reg_cnt DESC
</select>

<!-- 소모임 중첩 검색 -->
<select id="moimAllSearch" parameterType="hashMap" resultType="com.yedam.mohobby.service.moim.MoimVO">
	select * from moim
	where 1=1
	<if test ="moimName != null and moimName != ''">
          and moim_name like '%'||#{moimName}||'%'
    </if>
    <if test="moimCatg != null and moimCatg != ''">
          and moim_catg in(select SUB_KEYWORD_NAME
		  from sub_keyword 
		  where keyword_id = (select keyword_id from keyword where keyword_name like #{moimCatg}))
    </if>
    and <![CDATA[rownum <= 6]]> ORDER BY moim_id
</select>

<!-- 소모임 게시판 전체 조회 -->
<select id="moimAllBoard" parameterType="hashMap" resultType="com.yedam.mohobby.service.moim.MoimBoardVO">
	
	select b.*, nvl(c.cnt, 0)cnt
	from moim_board b,
	(select count(*)cnt, target_id from comments
	where target_id in (
	select board_id from moim_board)
	and target_type=3
	group by target_id)c
	where b.board_id = c.target_id(+)
	and moim_id = #{moimId}
	and board_type = #{boardType}

</select>

<!-- 모임명 중복체크 -->
<select id="moimIdCheck" resultType="Integer">
	SELECT COUNT(*) FROM moim WHERE moim_name = #{moimName}
</select>

<!-- 소모임 공지사항 전체 리스트 조회 -->
<select id="moimNoticeBaord" parameterType="hashMap" resultType="com.yedam.mohobby.service.moim.MoimBoardVO">
	select b.*, nvl(c.cnt, 0)cnt
	from moim_board b,
	(select count(*)cnt, target_id from comments
	where target_id in (
	select board_id from moim_board)
	and target_type=3
	group by target_id)c
	where b.board_id = c.target_id(+)
	and moim_id = #{moimId}
	and board_type = #{boardType}
</select>

<!-- 소모임 게시글내 댓글 전체 조회 -->
<select id="moimCommentAllList" parameterType="hashMap" resultType="com.yedam.mohobby.service.moim.MoimDetailVO"> 
	select c.comm_id, c.member_id as comment_writer, c.parent_comm_id, c.target_id, c.content, 
	        c.write_date as comment_date , m.board_id, m.board_type, m.moim_id
	from comments c ,moim_board m
	where c.target_id = m.board_id
	and c.target_type = 3
	and m.moim_id = #{moimId}
	and m.board_type = #{boardType}
	and m.board_id = #{boardId}
</select>

<!-- 소모임 게시글 단건조회 -->
<select id="moimOneBoard" parameterType="hashMap" resultType="com.yedam.mohobby.service.moim.MoimBoardVO">
	select * from moim_board
	where board_id = #{boardId}
	and board_type = #{boardType}
	and moim_id = #{moimId}
</select>

<!-- 소모임 게시글 댓글 등록 -->
<insert id="moimCommentInsert" parameterType="com.yedam.mohobby.service.communal.CommentsVO">
<selectKey keyProperty="commId" resultType="Integer" order="BEFORE">
   SELECT NVL(MAX(comm_id), 0)+1 FROM comments
</selectKey>
	INSERT INTO comments ( comm_id,
						   member_id,
						   target_id,
						   target_type,
						   content,
						   write_date
						)
	VALUES(#{commId},
		   #{memberId}, 
		   #{targetId}, 
		   3, 
		   #{content}, 
		   sysdate)
</insert>
</mapper>